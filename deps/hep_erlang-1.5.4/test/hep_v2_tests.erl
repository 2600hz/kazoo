%% -*- coding: utf-8 -*-
-module(hep_v2_tests).

%% hep_v2_tests: tests for module hep_v2.

-include_lib("eunit/include/eunit.hrl").
-include("hep.hrl").

-define(REAL_HEP_PAYLOAD,
       <<
         "REGISTER sip:edf5a1.sip.sandbox.2600hz.com SIP/2.0\r\n"
         "Via: SIP/2.0/UDP 10.26.0.114:64799;branch=z9hG4bKf73a952f360DEDA8\r\n"
         "From: \"user_z6kaub3kbd\" <sip:user_z6kaub3kbd@edf5a1.sip.sandbox.2600hz.com>;tag=5295CB65-6D5058C6\r\n"
         "To: <sip:user_z6kaub3kbd@edf5a1.sip.sandbox.2600hz.com>\r\n"
         "CSeq: 2 REGISTER\r\n"
         "Call-ID: 7cf7bfcc-7d5669f1-2a8e2ca2@10.26.0.114\r\n"
         "Contact: <sip:user_z6kaub3kbd@10.26.0.114:64799>;methods=\"INVITE, ACK, BYE, CANCEL, OPTIONS, INFO, MESSAGE, SUBSCRIBE, NOTIFY, PRACK, UPDATE, REFER\"\r\n"
         "User-Agent: PolycomSoundPointIP-SPIP_331-UA/4.1.1.0260\r\n"
         "Accept-Language: en\r\n"
         "Authorization: Digest username=\"user_z6kaub3kbd\", realm=\"edf5a1.sip.sandbox.2600hz.com\", nonce=\"VX+Xe1V/lk/Q/G/iIaejUoSN4P4YnSCr\", uri=\"sip:edf5a1.sip.sandbox.2600hz.com\", response=\"01497bbb0b57f7330d958cb6f85dfc07\", algorithm=MD5\r\n"
         "Max-Forwards: 70\r\n"
         "Expires: 360\r\n"
         "Content-Length: 0\r\n"
         "\r\n"
       >>).

%% API tests.

ipv4_encode_decode_test () ->
    Hep = hep(),
    {ok, Bin} = hep_v2:encode(Hep),
    ?assertEqual({ok, Hep}, hep_v2:decode(Bin)).

ipv6_encode_decode_test () ->
    Hep = (hep())#hep{ protocol_family = 'ipv6'
                     , src_ip = {1, 2, 3, 4, 5, 6, 7, 8}
                     , dst_ip = {8, 7, 6, 5, 4, 3, 2, 1}
                     },
    {ok, Bin} = hep_v2:encode(Hep),
    ?assertEqual({ok, Hep}, hep_v2:decode(Bin)).


decode_test () ->
    ?assertMatch({ok, #hep{ version = 'hep_v2'
                          , protocol_family = 'ipv4'
                          , protocol = 17
                          , src_ip = {10, 26, 0, 114}
                          , src_port = 64799
                          , dst_ip = {10, 26, 0, 182}
                          , dst_port = 5060
                          , timestamp = {1335,263061,1091373568}
                          , node_id = 14597
                          , payload_type = 'sip'
                          , payload = ?REAL_HEP_PAYLOAD
                          }
                 }, hep_v2:decode(real_bin())).

encode_test () ->
    Hep = real_hep(),
    {ok, Data} = hep_v2:encode(Hep),
    ?assertMatch({ok, #hep{ version = 'hep_v2'
                          , protocol_family = 'ipv4'
                          , protocol = 17
                          , src_ip = {10, 26, 0, 114}
                          , src_port = 64799
                          , dst_ip = {10, 26, 0, 182}
                          , dst_port = 5060
                          , timestamp = {1335,263061,1091373568}
                          , node_id = 14597
                          , payload_type = 'sip'
                          , payload = ?REAL_HEP_PAYLOAD
                          }
                 }, hep_v2:decode(Data)).

%% Internals

hep () ->
    #hep{ version = 'hep_v2'
        , protocol_family = 'ipv4'
        , protocol = 17
        , src_ip = {127, 0, 0, 1}
        , src_port = 1234
        , dst_ip = {0, 0, 0, 0}
        , dst_port = 5060
        , timestamp = {1313, 440459, 120000}
        , payload_type = 'sip'
        , node_id = 228
        , payload = <<"INVITE sip:bob">>
        }.

real_hep () ->
    #hep{ version = 'hep_v2'
        , protocol_family = 'ipv4'
        , protocol = 17
        , src_ip = {10, 26, 0, 114}
        , src_port = 64799
        , dst_ip = {10, 26, 0, 182}
        , dst_port = 5060
        , timestamp = {1335,263061,1091373568}
        , node_id = 14597
        , payload_type = 'sip'
        , payload = ?REAL_HEP_PAYLOAD
        , vendor = undefined
        }.

real_bin () ->
    <<
      2,16,2,17,253,31,19,196,10,26,0,114,10,26,0,182,79,150,127,85,65,13,10,0,57,
      5,117,0,82,69,71,73,83,84,69,82,32,115,105,112,58,101,100,102,53,97,49,46,
      115,105,112,46,115,97,110,100,98,111,120,46,50,54,48,48,104,122,46,99,111,
      109,32,83,73,80,47,50,46,48,13,10,86,105,97,58,32,83,73,80,47,50,46,48,47,85,
      68,80,32,49,48,46,50,54,46,48,46,49,49,52,58,54,52,55,57,57,59,98,114,97,110,
      99,104,61,122,57,104,71,52,98,75,102,55,51,97,57,53,50,102,51,54,48,68,69,68,
      65,56,13,10,70,114,111,109,58,32,34,117,115,101,114,95,122,54,107,97,117,98,
      51,107,98,100,34,32,60,115,105,112,58,117,115,101,114,95,122,54,107,97,117,
      98,51,107,98,100,64,101,100,102,53,97,49,46,115,105,112,46,115,97,110,100,98,
      111,120,46,50,54,48,48,104,122,46,99,111,109,62,59,116,97,103,61,53,50,57,53,
      67,66,54,53,45,54,68,53,48,53,56,67,54,13,10,84,111,58,32,60,115,105,112,58,
      117,115,101,114,95,122,54,107,97,117,98,51,107,98,100,64,101,100,102,53,97,
      49,46,115,105,112,46,115,97,110,100,98,111,120,46,50,54,48,48,104,122,46,99,
      111,109,62,13,10,67,83,101,113,58,32,50,32,82,69,71,73,83,84,69,82,13,10,67,
      97,108,108,45,73,68,58,32,55,99,102,55,98,102,99,99,45,55,100,53,54,54,57,
      102,49,45,50,97,56,101,50,99,97,50,64,49,48,46,50,54,46,48,46,49,49,52,13,10,
      67,111,110,116,97,99,116,58,32,60,115,105,112,58,117,115,101,114,95,122,54,
      107,97,117,98,51,107,98,100,64,49,48,46,50,54,46,48,46,49,49,52,58,54,52,55,
      57,57,62,59,109,101,116,104,111,100,115,61,34,73,78,86,73,84,69,44,32,65,67,
      75,44,32,66,89,69,44,32,67,65,78,67,69,76,44,32,79,80,84,73,79,78,83,44,32,
      73,78,70,79,44,32,77,69,83,83,65,71,69,44,32,83,85,66,83,67,82,73,66,69,44,
      32,78,79,84,73,70,89,44,32,80,82,65,67,75,44,32,85,80,68,65,84,69,44,32,82,
      69,70,69,82,34,13,10,85,115,101,114,45,65,103,101,110,116,58,32,80,111,108,
      121,99,111,109,83,111,117,110,100,80,111,105,110,116,73,80,45,83,80,73,80,95,
      51,51,49,45,85,65,47,52,46,49,46,49,46,48,50,54,48,13,10,65,99,99,101,112,
      116,45,76,97,110,103,117,97,103,101,58,32,101,110,13,10,65,117,116,104,111,
      114,105,122,97,116,105,111,110,58,32,68,105,103,101,115,116,32,117,115,101,
      114,110,97,109,101,61,34,117,115,101,114,95,122,54,107,97,117,98,51,107,98,
      100,34,44,32,114,101,97,108,109,61,34,101,100,102,53,97,49,46,115,105,112,46,
      115,97,110,100,98,111,120,46,50,54,48,48,104,122,46,99,111,109,34,44,32,110,
      111,110,99,101,61,34,86,88,43,88,101,49,86,47,108,107,47,81,47,71,47,105,73,
      97,101,106,85,111,83,78,52,80,52,89,110,83,67,114,34,44,32,117,114,105,61,34,
      115,105,112,58,101,100,102,53,97,49,46,115,105,112,46,115,97,110,100,98,111,
      120,46,50,54,48,48,104,122,46,99,111,109,34,44,32,114,101,115,112,111,110,
      115,101,61,34,48,49,52,57,55,98,98,98,48,98,53,55,102,55,51,51,48,100,57,53,
      56,99,98,54,102,56,53,100,102,99,48,55,34,44,32,97,108,103,111,114,105,116,
      104,109,61,77,68,53,13,10,77,97,120,45,70,111,114,119,97,114,100,115,58,32,
      55,48,13,10,69,120,112,105,114,101,115,58,32,51,54,48,13,10,67,111,110,116,
      101,110,116,45,76,101,110,103,116,104,58,32,48,13,10,13,10
    >>.

%% End of Module.
