language: erlang
notifications:
  email:
    - engineering@2600hz.com
    - operations@2600hz.com
  irc:
    channels:
      - "irc.freenode.org#2600hz-dev"

otp_release:
  - R16B
  - R15B03
  - R15B02

before_install:
  - set -e
  - sudo apt-get install -qq xsltproc
  - cd $HOME
  - git clone --depth=50 --branch=master https://github.com/manopapad/proper.git proper
  - cd proper
  - make fast
  - cd $TRAVIS_BUILD_DIR

script: make compile

after_success:
  - make xref
  - kerl_deactivate
  - source $HOME/otp/R16B/activate
  - make build-plt
  - echo .$first_commit.
  - git fetch origin master:master
  - first_commit=$(bash -c "curl https://patch-diff.githubusercontent.com/raw/$TRAVIS_REPO_SLUG/pull/$TRAVIS_PULL_REQUEST.patch -s | head -n 1 | cut -d ' ' -f 2 || true")
  - reference=$(bash -c "[[ $TRAVIS_PULL_REQUEST == false ]] && echo master || echo $first_commit")
  - files=$(bash -c "git diff --name-only $reference.. | grep -v deps/")
  - $TRAVIS_BUILD_DIR/scripts/check-dialyzer.escript $files
  - kerl_deactivate
  - source $HOME/otp/$TRAVIS_OTP_RELEASE/activate
  - ERL_LIBS="$HOME/proper" make test
