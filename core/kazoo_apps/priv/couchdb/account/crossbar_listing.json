{
    "_id": "_design/crossbar_listing",
    "kazoo": {
        "view_map": [
            {
                "classification": "account"
            }
        ]
    },
    "language": "javascript",
    "views": {
        "list_by_type_id": {
            "map": [
                "function(doc) {",
                "  if doc.pvt_deleted return;",
                "  var doc_type = doc.pvt_type",
                "  switch (doc_type)",
                "    case 'app':",
                "      emit([doc_type, doc.name], {",
                "        'id': doc._id,",
                "        'name': doc.name,",
                "        'phase': doc.phase,",
                "        'i18n': doc['i18n'],",
                "        'tags': doc.tags,",
                "        'api_url': doc.api_url,",
                "        'source_url': doc.source_url,",
                "        'published': doc.published",
                "      });",
                "      break;",
                "    case 'blacklist':",
                "      emit([doc_type, doc._id], {",
                "        'id': doc._id,",
                "        'name': doc.name,",
                "        'flags': doc.flags || []",
                "      });",
                "      break;",
                "    case 'callflow':",
                "      var featurecode = (!doc.featurecode) ? false : doc.featurecode;",
                "      var modules = [];",
                "      if (doc.flow) {",
                "        var walkTree = (function recursiveWalkTree(flow) {",
                "          if (flow.module && (flow.data && flow.data.skip_module !== true)) modules.push(flow.module);",
                "          if (flow.children) {",
                "            var children = flow.children;",
                "            for (var key in children) {",
                "              if (!children.hasOwnProperty(key)) continue;",
                "              recursiveWalkTree(children[key]);",
                "            }",
                "          }",
                "        })(doc.flow);",
                "      }",
                "      var onlyUnique = function(value, index, self) {",
                "        return self.indexOf(value) === index;",
                "      };",
                "      modules = modules.filter(onlyUnique);",
                "      emit([doc_type, doc._id], {",
                "        'id': doc._id,",
                "        'name': doc.name,",
                "        'type': doc.type,",
                "        'numbers': doc.numbers,",
                "        'patterns': doc.patterns,",
                "        'featurecode': featurecode,",
                "        'owner_id': doc.owner_id,",
                "        'group_id': doc.group_id,",
                "        'modules': modules,",
                "        'flags': doc.flags || []",
                "      });",
                "      break;",
                "    case 'device':",
                "      emit([doc_type, doc._id], {",
                "        'id': doc._id,",
                "        'name': doc.name,",
                "        'username': (doc.sip) ? doc.sip.username : undefined,",
                "        'mac_address': doc.mac_address || '',",
                "        'owner_id': doc.owner_id,",
                "        'enabled': doc.enabled,",
                "        'device_type': doc.device_type || 'sip_device',",
                "        'mobile': doc.mobile,",
                "        'call_recording': doc.call_recording,",
                "        'flags': doc.flags || []",
                "      });",
                "      break;",
                "    default:",
                "      emit([doc_type, doc._id], null);",
                "  }",
                "}"
            ]
        }
    }
}
