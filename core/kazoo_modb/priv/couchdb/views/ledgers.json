{
    "_id": "_design/ledgers",
    "kazoo": {
        "view_map": [
            {
                "classification": "modb"
            }
        ]
    },
    "language": "javascript",
    "views": {
        "list_by_source": {
            "map": [
                "function(doc) {",
                "  if (doc.pvt_deleted || doc.pvt_type !== 'ledger')",
                "    return;",
                "  var amount = doc.amount || 0;",
                "  if (doc.pvt_ledger_type === 'debit')",
                "    amount *= -1;",
                "  var result = {'amount': amount, 'source': doc.source, 'usage': doc.usage, 'metadata': doc.metadata || {}, 'executor': doc.executor || {}};",
                "  emit([doc.source.service, doc.pvt_created], result);",
                "}"
            ]
        },
        "list_by_timestamp": {
            "map": [
                "function(doc) {",
                "  if (doc.pvt_deleted || doc.pvt_type !== 'ledger') return;",
                "  emit([doc.pvt_created, doc.source.service, doc.account.id], {",
                "    'account_name': doc.account.name,",
                "    'amount': (doc.amount || 0) * (doc.pvt_ledger_type === 'debit' ? -1 : 1),",
                "    'usage': doc.usage || {}",
                "  });",
                "}"
            ],
            "reduce": [
                "function (keys, values, rereduce) {",
                "  if (rereduce) return values;",
                "  return values.reduce(function(reduceObj, obj) {",
                "    var objUsage = obj.usage || {};",
                "    var reduceUsage = reduceObj.usage || {};",
                "    return {",
                "      'account_name': reduceObj.account_name || obj.account_name,",
                "      'amount': (obj.amount || 0) + (reduceObj.amount || 0),",
                "      'usage': {",
                "        'type': reduceUsage.type || objUsage.type,",
                "        'quantity': (reduceUsage.quantity || 0) + (objUsage.quantity || 0),",
                "        'unit': reduceUsage.unit || objUsage.unit",
                "      }",
                "    }",
                "  })",
                "}"
            ]
        },
        "total_by_source": {
            "map": [
                "function(doc) {",
                "  if (doc.pvt_deleted || doc.pvt_type !== 'ledger')",
                "    return;",
                "  var amount = doc.amount || 0;",
                "  if (doc.pvt_ledger_type === 'debit')",
                "    amount *= -1;",
                "  emit([doc.source.service, doc.pvt_created], amount);",
                "}"
            ],
            "reduce": "_sum"
        }
    }
}
