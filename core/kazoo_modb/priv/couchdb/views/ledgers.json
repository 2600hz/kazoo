{
    "_id": "_design/ledgers",
    "kazoo": {
        "view_map": [
            {
                "classification": "modb"
            }
        ]
    },
    "language": "javascript",
    "views": {
        "list_by_source": {
            "map": [
                "function(doc) {",
                "  if (doc.pvt_deleted || doc.pvt_type !== 'ledger')",
                "    return;",
                "  var amount = doc.amount || 0;",
                "  if (doc.pvt_ledger_type === 'debit')",
                "    amount *= -1;",
                "  var result = {'amount': amount, 'source': doc.source, 'usage': doc.usage, 'metadata': doc.metadata || {}, 'executor': doc.executor || {}};",
                "  emit([doc.source.service, doc.pvt_created], result);",
                "}"
            ]
        },
        "list_by_timestamp": {
            "map": [
                "function(doc) {",
                "  if (doc.pvt_deleted || doc.pvt_type !== 'ledger')",
                "    return;",
                "  var accountId = doc.account.id;",
                "  var serviceName = doc.source.service;",
                "  var amount = (doc.amount || 0) * (doc.pvt_ledger_type === 'debit' ? -1 : 1);",
                "  var service = {",
                "    'amount': amount,",
                "    'usage': doc.usage || {}",
                "  };",
                "  var result = {};",
                "  result[accountId] = {",
                "    'account': doc.account,",
                "    'ledgers': {},",
                "    'total': amount",
                "  };",
                "  result[accountId]['ledgers'][serviceName] = service;",
                "  emit(doc.pvt_created, result);",
                "}"
            ],
            "reduce": [
                "function(keys, values, rereduce) {",
                "  return values.reduce(function(reduceObj, obj) {",
                "    for (var account in obj) {",
                "      if (!obj.hasOwnProperty(account)) continue;",
                "      var rootObj = obj[account];",
                "      var accountId = rootObj.account.id;",
                "      var ledgersObj = rootObj.ledgers;",
                "      var reduceAccount = reduceObj[accountId] || {};",
                "      var reduceLedgers = reduceAccount.ledgers || {};",
                "      var reduceTotal = reduceAccount.total || 0;",
                "      for (var service in ledgersObj) {",
                "        if (!ledgersObj.hasOwnProperty(service)) continue;",
                "          var serviceObj = ledgersObj[service];",
                "          var objUsageObj = serviceObj.usage || {};",
                "          var reduceService = reduceLedgers[service] || {};",
                "          var reduceServiceUsage = reduceService.usage || {};",
                "          var tmp = {",
                "            'amount': (serviceObj.amount || 0) + (reduceService.amount || 0),",
                "            'usage': {",
                "              'type': reduceServiceUsage.type || objUsageObj.type,",
                "              'quantity': (reduceServiceUsage.quantity || 0) + (objUsageObj.quantity || 0),",
                "              'unit': reduceServiceUsage.unit || objUsageObj.unit",
                "            }",
                "          };",
                "          reduceLedgers[service] = tmp;",
                "          reduceTotal += (serviceObj.amount || 0);",
                "      }",
                "      reduceAccount = {",
                "        'account': rootObj.account,",
                "        'ledgers': reduceLedgers,",
                "        'total': reduceTotal",
                "      };",
                "      reduceObj[accountId] = reduceAccount;",
                "    }",
                "    return reduceObj",
                "  }, {})",
                "}"
            ]
        },
        "total_by_source": {
            "map": [
                "function(doc) {",
                "  if (doc.pvt_deleted || doc.pvt_type !== 'ledger')",
                "    return;",
                "  var amount = doc.amount || 0;",
                "  if (doc.pvt_ledger_type === 'debit')",
                "    amount *= -1;",
                "  emit([doc.source.service, doc.pvt_created], amount);",
                "}"
            ],
            "reduce": "_sum"
        }
    }
}
