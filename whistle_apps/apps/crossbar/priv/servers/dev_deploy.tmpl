LOG=/tmp/{{ server._id }}-$(date +%s).log && echo -e '{\n    "normal": {\n    },\n    "name": "{{ server.hostname }}",\n    "override": {\n      "server_id": "{{ server._id }}"\n    },\n    "default": {\n    },\n    "json_class": "Chef::Node",\n    "automatic": {\n    },\n    "run_list": [\n    ],\n    "chef_type": "node"\n}\n' > /tmp/{{ account._id }}_{{ server._id }}_node.json && echo "# knife node from file /tmp/{{ account._id }}_{{ server._id }}_node.json" > $LOG && knife node from file /tmp/{{ account._id }}_{{ server._id }}_node.json >> $LOG 2>&1 && echo "# knife data bag from file accounts {{ databag_path }}" > $LOG && knife data bag from file accounts {{ databag_path }} >> $LOG 2>&1 && sleep 10 && echo "# knife role from file {{ role_path }}" >> $LOG && knife role from file {{ role_path }} >> $LOG 2>&1 && sleep 10 && echo "# knife bootstrap {{ server.ip }} -p {{ server.ssh_port }} -x root -P XXXX -N {{ server.hostname }} -d {{ server.os }} -r role[{{ account._id }}],{% for role in server.roles %}role[{{ role }}],{% endfor %}recipe[whistle::ecallmgr_start],recipe[whistle::whapps_start],recipe[chef-client::first_start]" >> $LOG && knife bootstrap {{ server.ip }} -p {{ server.ssh_port }} -x root -P {{ server.password }} -N {{ server.hostname }} -d {{ server.os }} -r role[{{ account._id }}],{% for role in server.roles %}role[{{ role }}],{% endfor %}recipe[whistle::ecallmgr_start],recipe[whistle::whapps_start],recipe[chef-client::first_start] >> $LOG 2>&1 && echo -n $LOG || echo -n $LOG
